import requests
from bs4 import BeautifulSoup
import time
import pandas as pd
import re
import datetime
import random
def get_owner_car_price():
    car_data = []
    headers = {"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36"}
    page = 1
    while True:
        url = f"https://www.kijiji.ca/b-cars-trucks/red-deer/page-{page}/c174l1700136?for-sale-by=ownr&view=list"
        req = requests.get(url,headers=headers)
        if req.status_code != 200:
            break
        soup = BeautifulSoup(req.text,"html.parser")
        car_card = soup.find_all("section",attrs={"data-testid":re.compile("listing-card")})
        if len(car_card) <= 0:
            print(f"NO CARS HERE!")
            break
        else:
            print(f"find{len(car_card)}cars")
        for car in car_card:
            try:
                car_name = car.find("a",attrs={"data-testid":re.compile("listing-link")})
                if not car_name:
                 continue
                car_title = car_name.text
                car_link = car_name['href']
                card_text = car.get_text(separator=" ", strip=True)
                mileage_match = re.search(r"(\d[\d,]*\s*km)", card_text, re.IGNORECASE)
                if mileage_match:
                    drive_distance = mileage_match.group(1)
                else:
                    drive_distance = "N/A"
                car_price = car.find("p",attrs={"data-testid":re.compile("listing-price")})
                if car_price:
                    p_price = car_price.text
                    if any(i.isdigit() for i in p_price):
                        price = float(p_price.replace("$","").replace(",","").strip())
                        car_data.append({"Car title":car_title,"Drive distance":drive_distance,"Price":price,"Link":car_link})
                        print(f"GET IT!{car_title}:{price}")
            except Exception as e:
                print(f"Something wrong in the try:{e}")
                continue
        time.sleep(random.uniform(5, 10))
        page += 1
        if page >100:
            break
    return car_data
if __name__ == "__main__":
    print(f"Car Price Check ON!") 
    data = get_owner_car_price()
    if data:
        today = datetime.datetime.now().strftime("%Y_%m_%d")
        filename = f"red_deer_{today}_owner_car_price.csv"
        df = pd.DataFrame(data)
        df_sorted = df.sort_values(by="Price")
        print(f"find {len(df)} cars")
        print(df_sorted)
        df_sorted.to_csv(filename, index=False, encoding="utf-8-sig")
        print(f"Today owner car price save as {filename}")
    else:
        print(f"FUCK! NO NEW CAR DATA TODAY!")